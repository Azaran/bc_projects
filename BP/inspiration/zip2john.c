<!DOCTYPE html>
<HTML LANG="en">
<HEAD>
<META http-equiv="content-type" content="text/html; charset=utf-8">
<META name="robots" content="nofollow">
<LINK rel="stylesheet" type="text/css" href="/style/fresh.css" />
<link rel="stylesheet" type="text/css" href="/fresh/highlight.css" />
<TITLE>John: src/zip2john.c | Fossies</TITLE>
</HEAD>
<BODY>
<H2><IMG SRC="/warix/forest1.gif" WIDTH="45" HEIGHT="29" ALT=""> "<A HREF="/">Fossies</A>" - the Fresh Open Source Software Archive <IMG SRC="/warix/forest2.gif" WIDTH="48" HEIGHT="30" ALT=""></H2>
<H3>Member "john-1.8.0-jumbo-1/src/zip2john.c" (11 Nov 2014, 24029 Bytes) of archive <A HREF="/" TITLE="Fossies homepage">/</A><A HREF="/linux/" TITLE="Listing of all main folders within the Fossies basic folder /linux/">linux</A>/<A HREF="/linux/privat/" TITLE="Listing of all packages within the Fossies folder /linux/privat/">privat</A>/<A HREF="/linux/privat/john-1.8.0-jumbo-1.tar.gz/" TITLE="Contents listing, member browsing, download with different compression formats, Doxygen generated source code documentation &amp; more ...">john-1.8.0-jumbo-1.tar.gz</A>:</H3>
<HR>
<DIV class="fresh_info">
As a special service "Fossies" has tried to format the requested source page into HTML format using  source code syntax highlighting with prefixed line numbers.
Alternatively you can here <A HREF="/linux/privat/john-1.8.0-jumbo-1.tar.gz/john-1.8.0-jumbo-1/src/zip2john.c?m=t">view</A> or <A HREF="/linux/privat/john-1.8.0-jumbo-1.tar.gz/john-1.8.0-jumbo-1/src/zip2john.c?m=b">download</A> the uninterpreted source code file.
A member file download can also be achieved by clicking within a package contents listing on the according byte size field. For more information about "zip2john.c" see the <span class="fresh_info_amo"><A HREF="/dox/" TITLE="Fossies doxygen-generated source code documentation (main page)" REL="nofollow">Fossies "Dox"</A></span> <a href="/dox/john-1.8.0-jumbo-1/zip2john_8c.html" TITLE="&quot;zip2john.c&quot;: Doxygen-generated file reference page with a dependency graph and documentation of  data structures, macros, typedefs and functions.">file reference</a> documentation and the latest <span class="fresh_info_amo"><A HREF="/diffs/" TITLE="Fossies source code differences reports (main page)" REL="nofollow">Fossies "Diffs"</A></span> side-by-side code changes report: <A HREF="/diffs/john/1.7.9-jumbo-7_vs_1.8.0-jumbo-1/src/zip2john.c-diff.html" TITLE="&quot;zip2john.c&quot; file has changes in the current release!" STYLE="white-space: nowrap;"><IMG SRC="/delta_answer_10.png" WIDTH="13" HEIGHT="13"> 1.7.9-jumbo-7_vs_1.8.0-jumbo-1</A>.
</DIV>
<HR>
<PRE class="hl">
<a name="l_1"></a><span class="hl lin">    1 </span><span class="hl com">/* zip2john processes input ZIP files into a format suitable for use with JtR.</span>
<a name="l_2"></a><span class="hl lin">    2 </span><span class="hl com"> *</span>
<a name="l_3"></a><span class="hl lin">    3 </span><span class="hl com"> * This software is Copyright (c) 2011, Dhiru Kholia &lt;dhiru.kholia at gmail.com&gt;,</span>
<a name="l_4"></a><span class="hl lin">    4 </span><span class="hl com"> * and it is hereby released to the general public under the following terms:</span>
<a name="l_5"></a><span class="hl lin">    5 </span><span class="hl com"> * Redistribution and use in source and binary forms, with or without modification,</span>
<a name="l_6"></a><span class="hl lin">    6 </span><span class="hl com"> * are permitted.</span>
<a name="l_7"></a><span class="hl lin">    7 </span><span class="hl com"> *</span>
<a name="l_8"></a><span class="hl lin">    8 </span><span class="hl com"> * Updated in Aug 2011 by JimF.  Added PKZIP 'old' encryption.  The signature on the</span>
<a name="l_9"></a><span class="hl lin">    9 </span><span class="hl com"> * pkzip will be $pkzip$ and does not look like the AES version written by Dhiru</span>
<a name="l_10"></a><span class="hl lin">   10 </span><span class="hl com"> * Also fixed some porting issues, such as variables needing declared at top of blocks.</span>
<a name="l_11"></a><span class="hl lin">   11 </span><span class="hl com"> *</span>
<a name="l_12"></a><span class="hl lin">   12 </span><span class="hl com"> * References:</span>
<a name="l_13"></a><span class="hl lin">   13 </span><span class="hl com"> *</span>
<a name="l_14"></a><span class="hl lin">   14 </span><span class="hl com"> * 1. http://www.winzip.com/aes_info.htm</span>
<a name="l_15"></a><span class="hl lin">   15 </span><span class="hl com"> * 2. http://www.winzip.com/aes_tips.htm</span>
<a name="l_16"></a><span class="hl lin">   16 </span><span class="hl com"> * 4. ftp://ftp.info-zip.org/pub/infozip/doc/appnote-iz-latest.zip</span>
<a name="l_17"></a><span class="hl lin">   17 </span><span class="hl com"> * 5. Nathan Moinvaziri's work in extending minizip to support AES.</span>
<a name="l_18"></a><span class="hl lin">   18 </span><span class="hl com"> * 6. http://oldhome.schmorp.de/marc/fcrackzip.html (coding hints)</span>
<a name="l_19"></a><span class="hl lin">   19 </span><span class="hl com"> * 7. http://www.pkware.com/documents/casestudies/APPNOTE.TXT</span>
<a name="l_20"></a><span class="hl lin">   20 </span><span class="hl com"> * 8. http://gladman.plushost.co.uk/oldsite/cryptography_technology/fileencrypt/index.php</span>
<a name="l_21"></a><span class="hl lin">   21 </span><span class="hl com"> *   (borrowed files have &quot;gladman_&quot; prepended to them)</span>
<a name="l_22"></a><span class="hl lin">   22 </span><span class="hl com"> * 9. http://svn.assembla.com/svn/os2utils/unzip60f/proginfo/extrafld.txt</span>
<a name="l_23"></a><span class="hl lin">   23 </span><span class="hl com"> * 10. http://emerge.hg.sourceforge.net/hgweb/emerge/emerge/diff/c2f208617d32/Source/unzip/proginfo/extrafld.txt</span>
<a name="l_24"></a><span class="hl lin">   24 </span><span class="hl com"> *</span>
<a name="l_25"></a><span class="hl lin">   25 </span><span class="hl com"> * Usage:</span>
<a name="l_26"></a><span class="hl lin">   26 </span><span class="hl com"> *</span>
<a name="l_27"></a><span class="hl lin">   27 </span><span class="hl com"> * 1. Run zip2john on zip file(s) as &quot;zip2john [zip files]&quot;.</span>
<a name="l_28"></a><span class="hl lin">   28 </span><span class="hl com"> *    Output is written to standard output.</span>
<a name="l_29"></a><span class="hl lin">   29 </span><span class="hl com"> * 2. Run JtR on the output generated by zip2john as &quot;john [output file]&quot;.</span>
<a name="l_30"></a><span class="hl lin">   30 </span><span class="hl com"> *</span>
<a name="l_31"></a><span class="hl lin">   31 </span><span class="hl com"> * Output Line Format:</span>
<a name="l_32"></a><span class="hl lin">   32 </span><span class="hl com"> *</span>
<a name="l_33"></a><span class="hl lin">   33 </span><span class="hl com"> * For type = 0, for ZIP files encrypted using AES</span>
<a name="l_34"></a><span class="hl lin">   34 </span><span class="hl com"> * filename:$zip$*type*hex(CRC)*encryption_strength*hex(salt)*hex(password_verfication_value):hex(authentication_code)</span>
<a name="l_35"></a><span class="hl lin">   35 </span><span class="hl com"> *</span>
<a name="l_36"></a><span class="hl lin">   36 </span><span class="hl com"> * For original pkzip encryption:  (JimF, with longer explaination of fields)</span>
<a name="l_37"></a><span class="hl lin">   37 </span><span class="hl com"> * filename:$pkzip$C*B*[DT*MT{CL*UL*CR*OF*OX}*CT*DL*CS*DA]*$/pkzip$   (deprecated)</span>
<a name="l_38"></a><span class="hl lin">   38 </span><span class="hl com"> * filename:$pkzip2$C*B*[DT*MT{CL*UL*CR*OF*OX}*CT*DL*CS*TC*DA]*$/pkzip2$   (new format, with 2 checksums)</span>
<a name="l_39"></a><span class="hl lin">   39 </span><span class="hl com"> * All numeric and 'binary data' fields are stored in hex.</span>
<a name="l_40"></a><span class="hl lin">   40 </span><span class="hl com"> *</span>
<a name="l_41"></a><span class="hl lin">   41 </span><span class="hl com"> * C   is the count of hashes present (the array of items, inside the []  C can be 1 to 3.).</span>
<a name="l_42"></a><span class="hl lin">   42 </span><span class="hl com"> * B   is number of valid bytes in the checksum (1 or 2).  Unix zip is 2 bytes, all others are 1 (NOTE, some can be 0)</span>
<a name="l_43"></a><span class="hl lin">   43 </span><span class="hl com"> * ARRAY of data starts here</span>
<a name="l_44"></a><span class="hl lin">   44 </span><span class="hl com"> *   DT  is a &quot;Data Type enum&quot;.  This will be 1 2 or 3.  1 is 'partial'. 2 and 3 are full file data (2 is inline, 3 is load from file).</span>
<a name="l_45"></a><span class="hl lin">   45 </span><span class="hl com"> *   MT  Magic Type enum.  0 is no 'type'.  255 is 'text'. Other types (like MS Doc, GIF, etc), see source.</span>
<a name="l_46"></a><span class="hl lin">   46 </span><span class="hl com"> *     NOTE, CL, DL, CRC, OFF are only present if DT != 1</span>
<a name="l_47"></a><span class="hl lin">   47 </span><span class="hl com"> *     CL  Compressed length of file blob data (includes 12 byte IV).</span>
<a name="l_48"></a><span class="hl lin">   48 </span><span class="hl com"> *     UL  Uncompressed length of the file.</span>
<a name="l_49"></a><span class="hl lin">   49 </span><span class="hl com"> *     CR  CRC32 of the 'final' file.</span>
<a name="l_50"></a><span class="hl lin">   50 </span><span class="hl com"> *     OF  Offset to the PK\x3\x4 record for this file data. If DT==2, then this will be a 0, as it is not needed, all of the data is already included in the line.</span>
<a name="l_51"></a><span class="hl lin">   51 </span><span class="hl com"> *     OX  Additional offset (past OF), to get to the zip data within the file.</span>
<a name="l_52"></a><span class="hl lin">   52 </span><span class="hl com"> *     END OF 'optional' fields.</span>
<a name="l_53"></a><span class="hl lin">   53 </span><span class="hl com"> *   CT  Compression type  (0 or 8)  0 is stored, 8 is imploded.</span>
<a name="l_54"></a><span class="hl lin">   54 </span><span class="hl com"> *   DL  Length of the DA data.</span>
<a name="l_55"></a><span class="hl lin">   55 </span><span class="hl com"> *   CS  2 bytes of checksum data.</span>
<a name="l_56"></a><span class="hl lin">   56 </span><span class="hl com"> *   TC  2 bytes of checksun data (fron timestamp)</span>
<a name="l_57"></a><span class="hl lin">   57 </span><span class="hl com"> *   DA  This is the 'data'.  It will be hex data if DT==1 or 2. If DT==3, then it is a filename (name of the .zip file).</span>
<a name="l_58"></a><span class="hl lin">   58 </span><span class="hl com"> * END of array item.  There will be C (count) array items.</span>
<a name="l_59"></a><span class="hl lin">   59 </span><span class="hl com"> * The format string will end with $/pkzip$</span>
<a name="l_60"></a><span class="hl lin">   60 </span><span class="hl com"> *</span>
<a name="l_61"></a><span class="hl lin">   61 </span><span class="hl com"> * The AES-zip format redone by JimF, Summer 2014.  Spent some time to understand the AES authentication code,</span>
<a name="l_62"></a><span class="hl lin">   62 </span><span class="hl com"> * and now have placed code to do this. However, this required format change.  The old AES format was:</span>
<a name="l_63"></a><span class="hl lin">   63 </span><span class="hl com"> *</span>
<a name="l_64"></a><span class="hl lin">   64 </span><span class="hl com"> *    For type = 0, for ZIP files encrypted using AES</span>
<a name="l_65"></a><span class="hl lin">   65 </span><span class="hl com"> *    filename:$zip$*type*hex(CRC)*encryption_strength*hex(salt)*hex(password_verfication_value):hex(authentication_code)</span>
<a name="l_66"></a><span class="hl lin">   66 </span><span class="hl com"> *     NOTE, the authentication code was NOT part of this, even though documented in this file. nor is hex(CRC) a part.</span>
<a name="l_67"></a><span class="hl lin">   67 </span><span class="hl com"> *</span>
<a name="l_68"></a><span class="hl lin">   68 </span><span class="hl com"> * The new format is:  (and the $zip$ is deprecated)</span>
<a name="l_69"></a><span class="hl lin">   69 </span><span class="hl com"> *</span>
<a name="l_70"></a><span class="hl lin">   70 </span><span class="hl com"> *    filename:$zip2$*Ty*Mo*Ma*Sa*Va*Le*DF*Au*$/zip2$</span>
<a name="l_71"></a><span class="hl lin">   71 </span><span class="hl com"> *    Ty = type (0) and ignored.</span>
<a name="l_72"></a><span class="hl lin">   72 </span><span class="hl com"> *    Mo = mode (1 2 3 for 128/192/256 bit)</span>
<a name="l_73"></a><span class="hl lin">   73 </span><span class="hl com"> *    Ma = magic (file magic).  This is reservered for now.  See pkzip_fmt_plug.c or zip2john.c for information.</span>
<a name="l_74"></a><span class="hl lin">   74 </span><span class="hl com"> *         For now, this must be a '0'</span>
<a name="l_75"></a><span class="hl lin">   75 </span><span class="hl com"> *    Sa = salt(hex).   8, 12 or 16 bytes of salt (depends on mode)</span>
<a name="l_76"></a><span class="hl lin">   76 </span><span class="hl com"> *    Va = Verification bytes(hex) (2 byte quick checker)</span>
<a name="l_77"></a><span class="hl lin">   77 </span><span class="hl com"> *    Le = real compr len (hex) length of compressed/encrypted data (field DF)</span>
<a name="l_78"></a><span class="hl lin">   78 </span><span class="hl com"> *    DF = compressed data DF can be Le*2 hex bytes, and if so, then it is the ENTIRE file blob written 'inline'.</span>
<a name="l_79"></a><span class="hl lin">   79 </span><span class="hl com"> *         However, if the data blob is too long, then a .zip ZIPDATA_FILE_PTR_RECORD structure will be the 'contents' of DF</span>
<a name="l_80"></a><span class="hl lin">   80 </span><span class="hl com"> *    Au = Authentication code (hex) a 10 byte hex value that is the hmac-sha1 of data over DF. This is the binary() value</span>
<a name="l_81"></a><span class="hl lin">   81 </span><span class="hl com"> *</span>
<a name="l_82"></a><span class="hl lin">   82 </span><span class="hl com"> *  ZIPDATA_FILE_PTR_RECORD  (this can be the 'DF' of this above hash line).</span>
<a name="l_83"></a><span class="hl lin">   83 </span><span class="hl com"> *      *ZFILE*Fn*Oh*Ob*  (Note, the leading and trailing * are the * that 'wrap' the DF object.</span>
<a name="l_84"></a><span class="hl lin">   84 </span><span class="hl com"> *  ZFILE This is the literal string ZFILE</span>
<a name="l_85"></a><span class="hl lin">   85 </span><span class="hl com"> *  Fn    This is the name of the .zip file.  NOTE the user will need to keep the .zip file in proper locations (same as</span>
<a name="l_86"></a><span class="hl lin">   86 </span><span class="hl com"> *        was seen when running zip2john. If the file is removed, this hash line will no longer be valid.</span>
<a name="l_87"></a><span class="hl lin">   87 </span><span class="hl com"> *  Oh    Offset to the zip central header record for this blob.</span>
<a name="l_88"></a><span class="hl lin">   88 </span><span class="hl com"> *  Ob    Offset to the start of the blob data</span>
<a name="l_89"></a><span class="hl lin">   89 </span><span class="hl com"> */</span>
<a name="l_90"></a><span class="hl lin">   90 </span>
<a name="l_91"></a><span class="hl lin">   91 </span><span class="hl ppc">#include &lt;stdio.h&gt;</span>
<a name="l_92"></a><span class="hl lin">   92 </span><span class="hl ppc">#include &lt;stdlib.h&gt;</span>
<a name="l_93"></a><span class="hl lin">   93 </span><span class="hl ppc">#include &lt;limits.h&gt;</span>
<a name="l_94"></a><span class="hl lin">   94 </span><span class="hl ppc">#include &lt;errno.h&gt;</span>
<a name="l_95"></a><span class="hl lin">   95 </span><span class="hl ppc">#include &lt;string.h&gt;</span>
<a name="l_96"></a><span class="hl lin">   96 </span><span class="hl ppc">#include &lt;assert.h&gt;</span>
<a name="l_97"></a><span class="hl lin">   97 </span><span class="hl ppc">#include &lt;ctype.h&gt;</span>
<a name="l_98"></a><span class="hl lin">   98 </span><span class="hl ppc">#if  (!AC_BUILT || HAVE_UNISTD_H) &amp;&amp; !_MSC_VER</span>
<a name="l_99"></a><span class="hl lin">   99 </span><span class="hl ppc">#include &lt;unistd.h&gt;</span>
<a name="l_100"></a><span class="hl lin">  100 </span><span class="hl ppc">#endif</span>
<a name="l_101"></a><span class="hl lin">  101 </span>
<a name="l_102"></a><span class="hl lin">  102 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;common.h&quot;</span><span class="hl ppc"></span>
<a name="l_103"></a><span class="hl lin">  103 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;jumbo.h&quot;</span><span class="hl ppc"></span>
<a name="l_104"></a><span class="hl lin">  104 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;formats.h&quot;</span><span class="hl ppc"></span>
<a name="l_105"></a><span class="hl lin">  105 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;stdint.h&quot;</span><span class="hl ppc"></span>
<a name="l_106"></a><span class="hl lin">  106 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;pkzip.h&quot;</span><span class="hl ppc"></span>
<a name="l_107"></a><span class="hl lin">  107 </span><span class="hl ppc">#ifdef _MSC_VER</span>
<a name="l_108"></a><span class="hl lin">  108 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;missing_getopt.h&quot;</span><span class="hl ppc"></span>
<a name="l_109"></a><span class="hl lin">  109 </span><span class="hl ppc">#endif</span>
<a name="l_110"></a><span class="hl lin">  110 </span><span class="hl ppc">#include</span> <span class="hl pps">&quot;memdbg.h&quot;</span><span class="hl ppc"></span>
<a name="l_111"></a><span class="hl lin">  111 </span>
<a name="l_112"></a><span class="hl lin">  112 </span><span class="hl ppc">#define LARGE_ENOUGH 8192</span>
<a name="l_113"></a><span class="hl lin">  113 </span>
<a name="l_114"></a><span class="hl lin">  114 </span><span class="hl kwb">static int</span> checksum_only<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">,</span> use_magic<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_115"></a><span class="hl lin">  115 </span><span class="hl kwb">static int</span> force_2_byte_checksum <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_116"></a><span class="hl lin">  116 </span><span class="hl kwb">static char</span> <span class="hl opt">*</span>ascii_fname<span class="hl opt">, *</span>only_fname<span class="hl opt">;</span>
<a name="l_117"></a><span class="hl lin">  117 </span><span class="hl kwb">static int</span> inline_thr <span class="hl opt">=</span> MAX_INLINE_SIZE<span class="hl opt">;</span>
<a name="l_118"></a><span class="hl lin">  118 </span><span class="hl ppc">#define MAX_THR (LINE_BUFFER_SIZE / 2 - 2 * PLAINTEXT_BUFFER_SIZE)</span>
<a name="l_119"></a><span class="hl lin">  119 </span>
<a name="l_120"></a><span class="hl lin">  120 </span><span class="hl kwb">static char</span> <span class="hl opt">*</span>MagicTypes<span class="hl opt">[]= {</span> <span class="hl str">&quot;&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;DOC&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;XLS&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;DOT&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;XLT&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;EXE&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;DLL&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;ZIP&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;BMP&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;DIB&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;GIF&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;PDF&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;GZ&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;TGZ&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;BZ2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;TZ2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;FLV&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;SWF&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;MP3&quot;</span><span class="hl opt">,</span> NULL <span class="hl opt">};</span>
<a name="l_121"></a><span class="hl lin">  121 </span><span class="hl kwb">static int</span>  MagicToEnum<span class="hl opt">[] = {</span><span class="hl num">0</span><span class="hl opt">,</span>  <span class="hl num">1</span><span class="hl opt">,</span>    <span class="hl num">1</span><span class="hl opt">,</span>     <span class="hl num">1</span><span class="hl opt">,</span>     <span class="hl num">1</span><span class="hl opt">,</span>     <span class="hl num">2</span><span class="hl opt">,</span>     <span class="hl num">2</span><span class="hl opt">,</span>     <span class="hl num">3</span><span class="hl opt">,</span>     <span class="hl num">4</span><span class="hl opt">,</span>     <span class="hl num">4</span><span class="hl opt">,</span>     <span class="hl num">5</span><span class="hl opt">,</span>     <span class="hl num">6</span><span class="hl opt">,</span>     <span class="hl num">7</span><span class="hl opt">,</span>    <span class="hl num">7</span><span class="hl opt">,</span>     <span class="hl num">8</span><span class="hl opt">,</span>     <span class="hl num">8</span><span class="hl opt">,</span>     <span class="hl num">9</span><span class="hl opt">,</span>     <span class="hl num">10</span><span class="hl opt">,</span>    <span class="hl num">11</span><span class="hl opt">,</span>  <span class="hl num">0</span><span class="hl opt">};</span>
<a name="l_122"></a><span class="hl lin">  122 </span>
<a name="l_123"></a><span class="hl lin">  123 </span><span class="hl kwb">static void</span> <span class="hl kwd">process_old_zip</span><span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>fname<span class="hl opt">);</span>
<a name="l_124"></a><span class="hl lin">  124 </span><span class="hl kwb">static void</span> <span class="hl kwd">process_file</span><span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>fname<span class="hl opt">)</span>
<a name="l_125"></a><span class="hl lin">  125 </span><span class="hl opt">{</span>
<a name="l_126"></a><span class="hl lin">  126 </span>	<span class="hl kwb">unsigned char</span> filename<span class="hl opt">[</span><span class="hl num">1024</span><span class="hl opt">];</span>
<a name="l_127"></a><span class="hl lin">  127 </span>	<span class="hl kwb">FILE</span> <span class="hl opt">*</span>fp<span class="hl opt">;</span>
<a name="l_128"></a><span class="hl lin">  128 </span>	<span class="hl kwb">int</span> i<span class="hl opt">;</span>
<a name="l_129"></a><span class="hl lin">  129 </span>	<span class="hl kwb">long long</span> off_sig<span class="hl opt">;</span>
<a name="l_130"></a><span class="hl lin">  130 </span>	<span class="hl kwb">char</span> path<span class="hl opt">[</span>LARGE_ENOUGH<span class="hl opt">];</span>
<a name="l_131"></a><span class="hl lin">  131 </span>	<span class="hl kwb">char</span> <span class="hl opt">*</span>cur<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">, *</span>cp<span class="hl opt">;</span>
<a name="l_132"></a><span class="hl lin">  132 </span>	<span class="hl kwb">uint32_t</span> best_len <span class="hl opt">=</span> <span class="hl num">0xffffffff</span><span class="hl opt">;</span>
<a name="l_133"></a><span class="hl lin">  133 </span>
<a name="l_134"></a><span class="hl lin">  134 </span>
<a name="l_135"></a><span class="hl lin">  135 </span>	<span class="hl kwa">if</span> <span class="hl opt">(!(</span>fp <span class="hl opt">=</span> <span class="hl kwd">fopen</span><span class="hl opt">(</span>fname<span class="hl opt">,</span> <span class="hl str">&quot;rb&quot;</span><span class="hl opt">))) {</span>
<a name="l_136"></a><span class="hl lin">  136 </span>		<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;! %s : %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">,</span> <span class="hl kwd">strerror</span><span class="hl opt">(</span>errno<span class="hl opt">));</span>
<a name="l_137"></a><span class="hl lin">  137 </span>		<span class="hl kwa">return</span><span class="hl opt">;</span>
<a name="l_138"></a><span class="hl lin">  138 </span>	<span class="hl opt">}</span>
<a name="l_139"></a><span class="hl lin">  139 </span>
<a name="l_140"></a><span class="hl lin">  140 </span>	<span class="hl kwa">while</span> <span class="hl opt">(!</span><span class="hl kwd">feof</span><span class="hl opt">(</span>fp<span class="hl opt">)) {</span>
<a name="l_141"></a><span class="hl lin">  141 </span>		<span class="hl kwb">uint32_t</span> id <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_142"></a><span class="hl lin">  142 </span>		<span class="hl kwb">uint32_t</span> store <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_143"></a><span class="hl lin">  143 </span>		off_sig <span class="hl opt">= (</span><span class="hl kwb">long long</span><span class="hl opt">) (</span><span class="hl kwd">ftell</span><span class="hl opt">(</span>fp<span class="hl opt">)-</span><span class="hl num">4</span><span class="hl opt">);</span>
<a name="l_144"></a><span class="hl lin">  144 </span>
<a name="l_145"></a><span class="hl lin">  145 </span>		<span class="hl kwa">if</span> <span class="hl opt">(</span>id <span class="hl opt">==</span> <span class="hl num">0x04034b50</span>UL<span class="hl opt">) {</span>	<span class="hl com">/* local header */</span>
<a name="l_146"></a><span class="hl lin">  146 </span>			<span class="hl kwb">uint16_t</span> version <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_147"></a><span class="hl lin">  147 </span>			<span class="hl kwb">uint16_t</span> flags <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_148"></a><span class="hl lin">  148 </span>			<span class="hl kwb">uint16_t</span> compression_method <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_149"></a><span class="hl lin">  149 </span>			<span class="hl kwb">uint16_t</span> lastmod_time <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_150"></a><span class="hl lin">  150 </span>			<span class="hl kwb">uint16_t</span> lastmod_date <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_151"></a><span class="hl lin">  151 </span>			<span class="hl kwb">uint32_t</span> crc <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_152"></a><span class="hl lin">  152 </span>			<span class="hl kwb">uint32_t</span> compressed_size <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_153"></a><span class="hl lin">  153 </span>			<span class="hl kwb">uint32_t</span> uncompressed_size <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_154"></a><span class="hl lin">  154 </span>			<span class="hl kwb">uint16_t</span> filename_length <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_155"></a><span class="hl lin">  155 </span>			<span class="hl kwb">uint16_t</span> extrafield_length <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_156"></a><span class="hl lin">  156 </span>			<span class="hl com">/* unused variables */</span>
<a name="l_157"></a><span class="hl lin">  157 </span>			<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> version<span class="hl opt">;</span>
<a name="l_158"></a><span class="hl lin">  158 </span>			<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> lastmod_time<span class="hl opt">;</span>
<a name="l_159"></a><span class="hl lin">  159 </span>			<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> lastmod_date<span class="hl opt">;</span>
<a name="l_160"></a><span class="hl lin">  160 </span>			<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> crc<span class="hl opt">;</span>
<a name="l_161"></a><span class="hl lin">  161 </span>			<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> uncompressed_size<span class="hl opt">;</span>
<a name="l_162"></a><span class="hl lin">  162 </span>
<a name="l_163"></a><span class="hl lin">  163 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span>filename_length <span class="hl opt">&gt;</span> <span class="hl num">250</span><span class="hl opt">) {</span>
<a name="l_164"></a><span class="hl lin">  164 </span>				<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;! %s: Invalid zip file, filename length too long!</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">);</span>
<a name="l_165"></a><span class="hl lin">  165 </span>				<span class="hl kwa">return</span><span class="hl opt">;</span>
<a name="l_166"></a><span class="hl lin">  166 </span>			<span class="hl opt">}</span>
<a name="l_167"></a><span class="hl lin">  167 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">fread</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> filename_length<span class="hl opt">,</span> fp<span class="hl opt">) !=</span> filename_length<span class="hl opt">) {</span>
<a name="l_168"></a><span class="hl lin">  168 </span>				<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Error, in fread of file data!</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_169"></a><span class="hl lin">  169 </span>				<span class="hl kwa">goto</span> cleanup<span class="hl opt">;</span>
<a name="l_170"></a><span class="hl lin">  170 </span>			<span class="hl opt">}</span>
<a name="l_171"></a><span class="hl lin">  171 </span>			filename<span class="hl opt">[</span>filename_length<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_172"></a><span class="hl lin">  172 </span>
<a name="l_173"></a><span class="hl lin">  173 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span>compression_method <span class="hl opt">==</span> <span class="hl num">99</span><span class="hl opt">) {</span>	<span class="hl com">/* AES encryption */</span>
<a name="l_174"></a><span class="hl lin">  174 </span>				<span class="hl kwb">uint32_t</span> real_cmpr_len<span class="hl opt">;</span>
<a name="l_175"></a><span class="hl lin">  175 </span>				<span class="hl kwb">uint16_t</span> efh_id <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_176"></a><span class="hl lin">  176 </span>				<span class="hl kwb">uint16_t</span> efh_datasize <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_177"></a><span class="hl lin">  177 </span>				<span class="hl kwb">uint16_t</span> efh_vendor_version <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_178"></a><span class="hl lin">  178 </span>				<span class="hl kwb">uint16_t</span> efh_vendor_id <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_179"></a><span class="hl lin">  179 </span>				<span class="hl kwb">char</span> efh_aes_strength <span class="hl opt">=</span> <span class="hl kwd">fgetc</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_180"></a><span class="hl lin">  180 </span>				<span class="hl kwb">uint16_t</span> actual_compression_method <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_181"></a><span class="hl lin">  181 </span>				<span class="hl kwb">unsigned char</span> salt<span class="hl opt">[</span><span class="hl num">16</span><span class="hl opt">],</span> d<span class="hl opt">;</span>
<a name="l_182"></a><span class="hl lin">  182 </span>				<span class="hl kwb">char</span> <span class="hl opt">*</span>bname<span class="hl opt">;</span>
<a name="l_183"></a><span class="hl lin">  183 </span>				<span class="hl kwb">int</span> magic_enum <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>  <span class="hl slc">// reserved at 0 for now, we are not computing this (yet).</span>
<a name="l_184"></a><span class="hl lin">  184 </span>
<a name="l_185"></a><span class="hl lin">  185 </span>				<span class="hl kwd">strnzcpy</span><span class="hl opt">(</span>path<span class="hl opt">,</span> fname<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>path<span class="hl opt">));</span>
<a name="l_186"></a><span class="hl lin">  186 </span>				bname <span class="hl opt">=</span> <span class="hl kwd">basename</span><span class="hl opt">(</span>path<span class="hl opt">);</span>
<a name="l_187"></a><span class="hl lin">  187 </span>				cp <span class="hl opt">=</span> cur<span class="hl opt">;</span>
<a name="l_188"></a><span class="hl lin">  188 </span>				<span class="hl kwa">if</span> <span class="hl opt">((</span><span class="hl kwb">unsigned</span><span class="hl opt">)</span>best_len <span class="hl opt">&lt;</span> compressed_size<span class="hl opt">) {</span>
<a name="l_189"></a><span class="hl lin">  189 </span><span class="hl ppc">#if DEBUG</span>
<a name="l_190"></a><span class="hl lin">  190 </span>					<span class="hl kwd">printf</span> <span class="hl opt">(</span><span class="hl str">&quot;This buffer not used, it is not 'best' size</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_191"></a><span class="hl lin">  191 </span><span class="hl ppc">#endif</span>
<a name="l_192"></a><span class="hl lin">  192 </span>				<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_193"></a><span class="hl lin">  193 </span>					store <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_194"></a><span class="hl lin">  194 </span>					best_len <span class="hl opt">=</span> compressed_size<span class="hl opt">;</span>
<a name="l_195"></a><span class="hl lin">  195 </span>					<span class="hl kwa">if</span> <span class="hl opt">(</span>cur<span class="hl opt">)</span> <span class="hl kwd">MEM_FREE</span><span class="hl opt">(</span>cur<span class="hl opt">);</span>
<a name="l_196"></a><span class="hl lin">  196 </span>					cur <span class="hl opt">=</span> <span class="hl kwd">mem_alloc</span><span class="hl opt">(</span>compressed_size<span class="hl opt">*</span><span class="hl num">2</span> <span class="hl opt">+</span> <span class="hl num">400</span><span class="hl opt">);</span>
<a name="l_197"></a><span class="hl lin">  197 </span>					cp <span class="hl opt">=</span> cur<span class="hl opt">;</span>
<a name="l_198"></a><span class="hl lin">  198 </span>				<span class="hl opt">}</span>
<a name="l_199"></a><span class="hl lin">  199 </span>
<a name="l_200"></a><span class="hl lin">  200 </span><span class="hl ppc">#if DEBUG</span>
<a name="l_201"></a><span class="hl lin">  201 </span>				<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span>
<a name="l_202"></a><span class="hl lin">  202 </span>				    <span class="hl str">&quot;%s-&gt;%s is using AES encryption, extrafield_length is %d</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span>
<a name="l_203"></a><span class="hl lin">  203 </span>				    fname<span class="hl opt">,</span> filename<span class="hl opt">,</span> extrafield_length<span class="hl opt">);</span>
<a name="l_204"></a><span class="hl lin">  204 </span><span class="hl ppc">#endif</span>
<a name="l_205"></a><span class="hl lin">  205 </span>				<span class="hl com">/* unused variables */</span>
<a name="l_206"></a><span class="hl lin">  206 </span>				<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> efh_id<span class="hl opt">;</span>
<a name="l_207"></a><span class="hl lin">  207 </span>				<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> efh_datasize<span class="hl opt">;</span>
<a name="l_208"></a><span class="hl lin">  208 </span>				<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> efh_vendor_version<span class="hl opt">;</span>
<a name="l_209"></a><span class="hl lin">  209 </span>				<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> efh_vendor_id<span class="hl opt">;</span>
<a name="l_210"></a><span class="hl lin">  210 </span>				<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> actual_compression_method<span class="hl opt">;</span> <span class="hl com">/* we need this!! */</span>
<a name="l_211"></a><span class="hl lin">  211 </span>
<a name="l_212"></a><span class="hl lin">  212 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;%s:$zip2$*0*%x*%x*&quot;</span><span class="hl opt">,</span> bname<span class="hl opt">,</span> efh_aes_strength<span class="hl opt">,</span> magic_enum<span class="hl opt">);</span>
<a name="l_213"></a><span class="hl lin">  213 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">fread</span><span class="hl opt">(</span>salt<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">+</span><span class="hl num">4</span><span class="hl opt">*</span>efh_aes_strength<span class="hl opt">,</span> fp<span class="hl opt">) !=</span> <span class="hl num">4</span><span class="hl opt">+</span><span class="hl num">4</span><span class="hl opt">*</span>efh_aes_strength<span class="hl opt">) {</span>
<a name="l_214"></a><span class="hl lin">  214 </span>						<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Error, in fread of file data!</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_215"></a><span class="hl lin">  215 </span>						<span class="hl kwa">goto</span> cleanup<span class="hl opt">;</span>
<a name="l_216"></a><span class="hl lin">  216 </span>				<span class="hl opt">}</span>
<a name="l_217"></a><span class="hl lin">  217 </span>
<a name="l_218"></a><span class="hl lin">  218 </span>				<span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">4</span><span class="hl opt">+</span><span class="hl num">4</span><span class="hl opt">*</span>efh_aes_strength<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
<a name="l_219"></a><span class="hl lin">  219 </span>					<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;%c%c&quot;</span><span class="hl opt">,</span>
<a name="l_220"></a><span class="hl lin">  220 </span>						itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>salt<span class="hl opt">[</span>i<span class="hl opt">] &gt;&gt;</span> <span class="hl num">4</span><span class="hl opt">)],</span>
<a name="l_221"></a><span class="hl lin">  221 </span>						itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>salt<span class="hl opt">[</span>i<span class="hl opt">] &amp;</span> <span class="hl num">0x0f</span><span class="hl opt">)]);</span>
<a name="l_222"></a><span class="hl lin">  222 </span>				<span class="hl opt">}</span>
<a name="l_223"></a><span class="hl lin">  223 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span> <span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;*&quot;</span><span class="hl opt">);</span>
<a name="l_224"></a><span class="hl lin">  224 </span>				<span class="hl slc">// since in the format we read/compare this one, we do it char by</span>
<a name="l_225"></a><span class="hl lin">  225 </span>				<span class="hl slc">// char, so there is no endianity swapping needed. (validator)</span>
<a name="l_226"></a><span class="hl lin">  226 </span>				<span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
<a name="l_227"></a><span class="hl lin">  227 </span>					d <span class="hl opt">=</span> <span class="hl kwd">fgetc</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_228"></a><span class="hl lin">  228 </span>					<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;%c%c&quot;</span><span class="hl opt">,</span>
<a name="l_229"></a><span class="hl lin">  229 </span>						itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>d <span class="hl opt">&gt;&gt;</span> <span class="hl num">4</span><span class="hl opt">)],</span>
<a name="l_230"></a><span class="hl lin">  230 </span>						itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>d <span class="hl opt">&amp;</span> <span class="hl num">0x0f</span><span class="hl opt">)]);</span>
<a name="l_231"></a><span class="hl lin">  231 </span>				<span class="hl opt">}</span>
<a name="l_232"></a><span class="hl lin">  232 </span>				real_cmpr_len <span class="hl opt">=</span> compressed_size<span class="hl opt">-</span><span class="hl num">2</span><span class="hl opt">-(</span><span class="hl num">4</span><span class="hl opt">+</span><span class="hl num">4</span><span class="hl opt">*</span>efh_aes_strength<span class="hl opt">)-</span>extrafield_length<span class="hl opt">;</span>
<a name="l_233"></a><span class="hl lin">  233 </span>				<span class="hl slc">// not quite sure why the real_cmpr_len is 'off by 1' ????</span>
<a name="l_234"></a><span class="hl lin">  234 </span>				<span class="hl opt">++</span>real_cmpr_len<span class="hl opt">;</span>
<a name="l_235"></a><span class="hl lin">  235 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;*%x*&quot;</span><span class="hl opt">,</span> real_cmpr_len<span class="hl opt">);</span>
<a name="l_236"></a><span class="hl lin">  236 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>real_cmpr_len <span class="hl opt">&lt;</span> inline_thr<span class="hl opt">) {</span>
<a name="l_237"></a><span class="hl lin">  237 </span>					<span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> real_cmpr_len<span class="hl opt">;</span> i<span class="hl opt">++) {</span>
<a name="l_238"></a><span class="hl lin">  238 </span>						d <span class="hl opt">=</span> <span class="hl kwd">fgetc</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_239"></a><span class="hl lin">  239 </span>						<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;%c%c&quot;</span><span class="hl opt">,</span>
<a name="l_240"></a><span class="hl lin">  240 </span>							itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>d <span class="hl opt">&gt;&gt;</span> <span class="hl num">4</span><span class="hl opt">)],</span>
<a name="l_241"></a><span class="hl lin">  241 </span>							itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>d <span class="hl opt">&amp;</span> <span class="hl num">0x0f</span><span class="hl opt">)]);</span>
<a name="l_242"></a><span class="hl lin">  242 </span>					<span class="hl opt">}</span>
<a name="l_243"></a><span class="hl lin">  243 </span>				<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_244"></a><span class="hl lin">  244 </span>					<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;ZFILE*%s*&quot;</span>LLx<span class="hl str">&quot;*&quot;</span>LLx<span class="hl opt">,</span>
<a name="l_245"></a><span class="hl lin">  245 </span>							fname<span class="hl opt">,</span> off_sig<span class="hl opt">, (</span><span class="hl kwb">long long</span><span class="hl opt">)(</span><span class="hl kwd">ftell</span><span class="hl opt">(</span>fp<span class="hl opt">)));</span>
<a name="l_246"></a><span class="hl lin">  246 </span>					<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> real_cmpr_len<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_247"></a><span class="hl lin">  247 </span>				<span class="hl opt">}</span>
<a name="l_248"></a><span class="hl lin">  248 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;*&quot;</span><span class="hl opt">);</span>
<a name="l_249"></a><span class="hl lin">  249 </span>				<span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> <span class="hl num">10</span><span class="hl opt">;</span> i<span class="hl opt">++) {</span>
<a name="l_250"></a><span class="hl lin">  250 </span>					d <span class="hl opt">=</span> <span class="hl kwd">fgetc</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_251"></a><span class="hl lin">  251 </span>					<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;%c%c&quot;</span><span class="hl opt">,</span>
<a name="l_252"></a><span class="hl lin">  252 </span>					    itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>d <span class="hl opt">&gt;&gt;</span> <span class="hl num">4</span><span class="hl opt">)],</span>
<a name="l_253"></a><span class="hl lin">  253 </span>					    itoa16<span class="hl opt">[</span><span class="hl kwd">ARCH_INDEX</span><span class="hl opt">(</span>d <span class="hl opt">&amp;</span> <span class="hl num">0x0f</span><span class="hl opt">)]);</span>
<a name="l_254"></a><span class="hl lin">  254 </span>				<span class="hl opt">}</span>
<a name="l_255"></a><span class="hl lin">  255 </span>				<span class="hl kwa">for</span> <span class="hl opt">(</span>d <span class="hl opt">=</span> <span class="hl str">' '</span><span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">;</span> d <span class="hl opt">&lt;</span> <span class="hl str">'~'</span><span class="hl opt">; ++</span>d<span class="hl opt">) {</span>
<a name="l_256"></a><span class="hl lin">  256 </span>					<span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">strchr</span><span class="hl opt">(</span>fname<span class="hl opt">,</span> d<span class="hl opt">) &amp;&amp;</span> d <span class="hl opt">!=</span> <span class="hl str">':'</span> <span class="hl opt">&amp;&amp; !</span><span class="hl kwd">isxdigit</span><span class="hl opt">(</span>d<span class="hl opt">))</span>
<a name="l_257"></a><span class="hl lin">  257 </span>						<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_258"></a><span class="hl lin">  258 </span>				<span class="hl opt">}</span>
<a name="l_259"></a><span class="hl lin">  259 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>store<span class="hl opt">)</span> cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;*$/zip2$:::::%s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> bname<span class="hl opt">);</span>
<a name="l_260"></a><span class="hl lin">  260 </span>			<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>flags <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">) {</span>	<span class="hl com">/* old encryption */</span>
<a name="l_261"></a><span class="hl lin">  261 </span>				<span class="hl kwd">fclose</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_262"></a><span class="hl lin">  262 </span>				fp <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_263"></a><span class="hl lin">  263 </span>				<span class="hl kwd">process_old_zip</span><span class="hl opt">(</span>fname<span class="hl opt">);</span>
<a name="l_264"></a><span class="hl lin">  264 </span>				<span class="hl kwa">return</span><span class="hl opt">;</span>
<a name="l_265"></a><span class="hl lin">  265 </span>			<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_266"></a><span class="hl lin">  266 </span>				<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;%s-&gt;%s is not encrypted!</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">,</span>
<a name="l_267"></a><span class="hl lin">  267 </span>				    filename<span class="hl opt">);</span>
<a name="l_268"></a><span class="hl lin">  268 </span>				<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> extrafield_length<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_269"></a><span class="hl lin">  269 </span>				<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> compressed_size<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_270"></a><span class="hl lin">  270 </span>			<span class="hl opt">}</span>
<a name="l_271"></a><span class="hl lin">  271 </span>		<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>id <span class="hl opt">==</span> <span class="hl num">0x08074b50</span>UL<span class="hl opt">) {</span>	<span class="hl com">/* data descriptor */</span>
<a name="l_272"></a><span class="hl lin">  272 </span>			<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> <span class="hl num">12</span><span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_273"></a><span class="hl lin">  273 </span>		<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>id <span class="hl opt">==</span> <span class="hl num">0x02014b50</span>UL <span class="hl opt">||</span> id <span class="hl opt">==</span> <span class="hl num">0x06054b50</span>UL<span class="hl opt">) {</span>	<span class="hl com">/* central directory structures */</span>
<a name="l_274"></a><span class="hl lin">  274 </span>			<span class="hl kwa">goto</span> cleanup<span class="hl opt">;</span>
<a name="l_275"></a><span class="hl lin">  275 </span>		<span class="hl opt">}</span>
<a name="l_276"></a><span class="hl lin">  276 </span>	<span class="hl opt">}</span>
<a name="l_277"></a><span class="hl lin">  277 </span>
<a name="l_278"></a><span class="hl lin">  278 </span>cleanup<span class="hl opt">:</span>
<a name="l_279"></a><span class="hl lin">  279 </span>	<span class="hl kwa">if</span> <span class="hl opt">(</span>cur<span class="hl opt">)</span>
<a name="l_280"></a><span class="hl lin">  280 </span>		<span class="hl kwd">printf</span> <span class="hl opt">(</span><span class="hl str">&quot;%s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span>cur<span class="hl opt">);</span>
<a name="l_281"></a><span class="hl lin">  281 </span>	<span class="hl kwd">fclose</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_282"></a><span class="hl lin">  282 </span><span class="hl opt">}</span>
<a name="l_283"></a><span class="hl lin">  283 </span>
<a name="l_284"></a><span class="hl lin">  284 </span><span class="hl com">/* instead of using anything from the process_file, we simply detected a encrypted old style</span>
<a name="l_285"></a><span class="hl lin">  285 </span><span class="hl com"> * password, close the file, and call this function.  This function handles the older pkzip</span>
<a name="l_286"></a><span class="hl lin">  286 </span><span class="hl com"> * password, while the process_file handles ONLY the AES from WinZip</span>
<a name="l_287"></a><span class="hl lin">  287 </span><span class="hl com"> */</span>
<a name="l_288"></a><span class="hl lin">  288 </span><span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> _zip_ptr
<a name="l_289"></a><span class="hl lin">  289 </span><span class="hl opt">{</span>
<a name="l_290"></a><span class="hl lin">  290 </span>	<span class="hl kwb">uint16_t</span>      magic_type<span class="hl opt">,</span> cmptype<span class="hl opt">;</span>
<a name="l_291"></a><span class="hl lin">  291 </span>	<span class="hl kwb">uint32_t</span>      offset<span class="hl opt">,</span> offex<span class="hl opt">,</span> crc<span class="hl opt">,</span> cmp_len<span class="hl opt">,</span> decomp_len<span class="hl opt">;</span>
<a name="l_292"></a><span class="hl lin">  292 </span>	<span class="hl kwb">char</span>          chksum<span class="hl opt">[</span><span class="hl num">5</span><span class="hl opt">];</span>
<a name="l_293"></a><span class="hl lin">  293 </span>	<span class="hl kwb">char</span>          chksum2<span class="hl opt">[</span><span class="hl num">5</span><span class="hl opt">];</span>
<a name="l_294"></a><span class="hl lin">  294 </span>	<span class="hl kwb">char</span>         <span class="hl opt">*</span>hash_data<span class="hl opt">;</span>
<a name="l_295"></a><span class="hl lin">  295 </span><span class="hl opt">}</span> zip_ptr<span class="hl opt">;</span>
<a name="l_296"></a><span class="hl lin">  296 </span><span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> _zip_file
<a name="l_297"></a><span class="hl lin">  297 </span><span class="hl opt">{</span>
<a name="l_298"></a><span class="hl lin">  298 </span>	<span class="hl kwb">int</span> unix_made<span class="hl opt">;</span>
<a name="l_299"></a><span class="hl lin">  299 </span>	<span class="hl kwb">int</span> check_in_crc<span class="hl opt">;</span>
<a name="l_300"></a><span class="hl lin">  300 </span>	<span class="hl kwb">int</span> check_bytes<span class="hl opt">;</span>
<a name="l_301"></a><span class="hl lin">  301 </span><span class="hl opt">}</span> zip_file<span class="hl opt">;</span>
<a name="l_302"></a><span class="hl lin">  302 </span>
<a name="l_303"></a><span class="hl lin">  303 </span><span class="hl kwb">static int</span> <span class="hl kwd">magic_type</span><span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>filename<span class="hl opt">) {</span>
<a name="l_304"></a><span class="hl lin">  304 </span>	<span class="hl kwb">char</span> <span class="hl opt">*</span>Buf <span class="hl opt">=</span> <span class="hl kwd">str_alloc_copy</span><span class="hl opt">((</span><span class="hl kwb">char</span><span class="hl opt">*)</span>filename<span class="hl opt">), *</span>cp<span class="hl opt">;</span>
<a name="l_305"></a><span class="hl lin">  305 </span>	<span class="hl kwb">int</span> i<span class="hl opt">;</span>
<a name="l_306"></a><span class="hl lin">  306 </span>
<a name="l_307"></a><span class="hl lin">  307 </span>	<span class="hl kwa">if</span> <span class="hl opt">(!</span>use_magic<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_308"></a><span class="hl lin">  308 </span>
<a name="l_309"></a><span class="hl lin">  309 </span>	<span class="hl kwd">strupr</span><span class="hl opt">(</span>Buf<span class="hl opt">);</span>
<a name="l_310"></a><span class="hl lin">  310 </span>	<span class="hl kwa">if</span> <span class="hl opt">(</span>ascii_fname <span class="hl opt">&amp;&amp; !</span><span class="hl kwd">strcasecmp</span><span class="hl opt">(</span>Buf<span class="hl opt">,</span> ascii_fname<span class="hl opt">))</span>
<a name="l_311"></a><span class="hl lin">  311 </span>		<span class="hl kwa">return</span> <span class="hl num">255</span><span class="hl opt">;</span>
<a name="l_312"></a><span class="hl lin">  312 </span>
<a name="l_313"></a><span class="hl lin">  313 </span>	cp <span class="hl opt">=</span> <span class="hl kwd">strrchr</span><span class="hl opt">(</span>Buf<span class="hl opt">,</span> <span class="hl str">'.'</span><span class="hl opt">);</span>
<a name="l_314"></a><span class="hl lin">  314 </span>	<span class="hl kwa">if</span> <span class="hl opt">(!</span>cp<span class="hl opt">)</span> <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_315"></a><span class="hl lin">  315 </span>	<span class="hl opt">++</span>cp<span class="hl opt">;</span>
<a name="l_316"></a><span class="hl lin">  316 </span>	<span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> MagicTypes<span class="hl opt">[</span>i<span class="hl opt">]; ++</span>i<span class="hl opt">)</span>
<a name="l_317"></a><span class="hl lin">  317 </span>		<span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">strcmp</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> MagicTypes<span class="hl opt">[</span>i<span class="hl opt">]))</span>
<a name="l_318"></a><span class="hl lin">  318 </span>			<span class="hl kwa">return</span> MagicToEnum<span class="hl opt">[</span>i<span class="hl opt">];</span>
<a name="l_319"></a><span class="hl lin">  319 </span>	<span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_320"></a><span class="hl lin">  320 </span><span class="hl opt">}</span>
<a name="l_321"></a><span class="hl lin">  321 </span><span class="hl kwb">static char</span> <span class="hl opt">*</span><span class="hl kwd">toHex</span><span class="hl opt">(</span><span class="hl kwb">unsigned char</span> <span class="hl opt">*</span>p<span class="hl opt">,</span> <span class="hl kwb">int</span> len<span class="hl opt">) {</span>
<a name="l_322"></a><span class="hl lin">  322 </span>	<span class="hl kwb">static char</span> Buf<span class="hl opt">[</span><span class="hl num">4096</span><span class="hl opt">];</span>
<a name="l_323"></a><span class="hl lin">  323 </span>	<span class="hl kwb">char</span> <span class="hl opt">*</span>cp <span class="hl opt">=</span> Buf<span class="hl opt">;</span>
<a name="l_324"></a><span class="hl lin">  324 </span>	<span class="hl kwb">int</span> i<span class="hl opt">;</span>
<a name="l_325"></a><span class="hl lin">  325 </span>	<span class="hl kwa">for</span> <span class="hl opt">(</span>i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> i <span class="hl opt">&lt;</span> len<span class="hl opt">; ++</span>i<span class="hl opt">)</span>
<a name="l_326"></a><span class="hl lin">  326 </span>		cp <span class="hl opt">+=</span> <span class="hl kwd">sprintf</span><span class="hl opt">(</span>cp<span class="hl opt">,</span> <span class="hl str">&quot;%02x&quot;</span><span class="hl opt">,</span> p<span class="hl opt">[</span>i<span class="hl opt">]);</span>
<a name="l_327"></a><span class="hl lin">  327 </span>	<span class="hl kwa">return</span> Buf<span class="hl opt">;</span>
<a name="l_328"></a><span class="hl lin">  328 </span><span class="hl opt">}</span>
<a name="l_329"></a><span class="hl lin">  329 </span><span class="hl kwb">static int</span> <span class="hl kwd">LoadZipBlob</span><span class="hl opt">(</span><span class="hl kwb">FILE</span> <span class="hl opt">*</span>fp<span class="hl opt">,</span> zip_ptr <span class="hl opt">*</span>p<span class="hl opt">,</span> zip_file <span class="hl opt">*</span>zfp<span class="hl opt">,</span> <span class="hl kwb">const char</span> <span class="hl opt">*</span>zip_fname<span class="hl opt">)</span>
<a name="l_330"></a><span class="hl lin">  330 </span><span class="hl opt">{</span>
<a name="l_331"></a><span class="hl lin">  331 </span>	<span class="hl kwb">uint16_t</span> version<span class="hl opt">,</span>flags<span class="hl opt">,</span>lastmod_time<span class="hl opt">,</span>lastmod_date<span class="hl opt">,</span>filename_length<span class="hl opt">,</span>extrafield_length<span class="hl opt">;</span>
<a name="l_332"></a><span class="hl lin">  332 </span>	<span class="hl kwb">unsigned char</span> filename<span class="hl opt">[</span><span class="hl num">1024</span><span class="hl opt">];</span>
<a name="l_333"></a><span class="hl lin">  333 </span>
<a name="l_334"></a><span class="hl lin">  334 </span>	<span class="hl kwd">memset</span><span class="hl opt">(</span>p<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(*</span>p<span class="hl opt">));</span>
<a name="l_335"></a><span class="hl lin">  335 </span>
<a name="l_336"></a><span class="hl lin">  336 </span>	p<span class="hl opt">-&gt;</span>offset <span class="hl opt">=</span> <span class="hl kwd">ftell</span><span class="hl opt">(</span>fp<span class="hl opt">)-</span><span class="hl num">4</span><span class="hl opt">;</span>
<a name="l_337"></a><span class="hl lin">  337 </span>	version <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_338"></a><span class="hl lin">  338 </span>	flags <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_339"></a><span class="hl lin">  339 </span>	p<span class="hl opt">-&gt;</span>cmptype <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_340"></a><span class="hl lin">  340 </span>	lastmod_time <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_341"></a><span class="hl lin">  341 </span>	lastmod_date <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_342"></a><span class="hl lin">  342 </span>	p<span class="hl opt">-&gt;</span>crc <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_343"></a><span class="hl lin">  343 </span>	p<span class="hl opt">-&gt;</span>cmp_len<span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_344"></a><span class="hl lin">  344 </span>	p<span class="hl opt">-&gt;</span>decomp_len <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_345"></a><span class="hl lin">  345 </span>	filename_length <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_346"></a><span class="hl lin">  346 </span>	extrafield_length <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_347"></a><span class="hl lin">  347 </span>	<span class="hl com">/* unused variables */</span>
<a name="l_348"></a><span class="hl lin">  348 </span>	<span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">)</span> lastmod_date<span class="hl opt">;</span>
<a name="l_349"></a><span class="hl lin">  349 </span>
<a name="l_350"></a><span class="hl lin">  350 </span>	<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">fread</span><span class="hl opt">(</span>filename<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> filename_length<span class="hl opt">,</span> fp<span class="hl opt">) !=</span> filename_length<span class="hl opt">) {</span>
<a name="l_351"></a><span class="hl lin">  351 </span>		<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Error, fread could not read the data from the file:  %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> zip_fname<span class="hl opt">);</span>
<a name="l_352"></a><span class="hl lin">  352 </span>		<span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_353"></a><span class="hl lin">  353 </span>	<span class="hl opt">}</span>
<a name="l_354"></a><span class="hl lin">  354 </span>	filename<span class="hl opt">[</span>filename_length<span class="hl opt">] =</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_355"></a><span class="hl lin">  355 </span>	p<span class="hl opt">-&gt;</span>magic_type <span class="hl opt">=</span> <span class="hl kwd">magic_type</span><span class="hl opt">((</span><span class="hl kwb">char</span><span class="hl opt">*)</span>filename<span class="hl opt">);</span>
<a name="l_356"></a><span class="hl lin">  356 </span>
<a name="l_357"></a><span class="hl lin">  357 </span>	p<span class="hl opt">-&gt;</span>offex <span class="hl opt">=</span> <span class="hl num">30</span> <span class="hl opt">+</span> filename_length <span class="hl opt">+</span> extrafield_length<span class="hl opt">;</span>
<a name="l_358"></a><span class="hl lin">  358 </span>
<a name="l_359"></a><span class="hl lin">  359 </span>	<span class="hl slc">// we only handle implode or store.</span>
<a name="l_360"></a><span class="hl lin">  360 </span>	<span class="hl slc">// 0x314 was seen at 2012 CMIYC ?? I have to look into that one.</span>
<a name="l_361"></a><span class="hl lin">  361 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;ver %0x  &quot;</span><span class="hl opt">,</span> version<span class="hl opt">);</span>
<a name="l_362"></a><span class="hl lin">  362 </span>	<span class="hl kwa">if</span> <span class="hl opt">( !(</span>only_fname <span class="hl opt">&amp;&amp;</span> <span class="hl kwd">strcmp</span><span class="hl opt">(</span>only_fname<span class="hl opt">, (</span><span class="hl kwb">char</span><span class="hl opt">*)</span>filename<span class="hl opt">)) &amp;&amp; (</span>version <span class="hl opt">==</span> <span class="hl num">0x14</span><span class="hl opt">||</span>version<span class="hl opt">==</span><span class="hl num">0xA</span><span class="hl opt">||</span>version <span class="hl opt">==</span> <span class="hl num">0x314</span><span class="hl opt">) &amp;&amp; (</span>flags <span class="hl opt">&amp;</span> <span class="hl num">1</span><span class="hl opt">)) {</span>
<a name="l_363"></a><span class="hl lin">  363 </span>		<span class="hl kwb">uint16_t</span> extra_len_used <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_364"></a><span class="hl lin">  364 </span>		<span class="hl kwa">if</span> <span class="hl opt">(</span>flags <span class="hl opt">&amp;</span> <span class="hl num">8</span><span class="hl opt">) {</span>
<a name="l_365"></a><span class="hl lin">  365 </span>			<span class="hl kwa">while</span> <span class="hl opt">(</span>extra_len_used <span class="hl opt">&lt;</span> extrafield_length<span class="hl opt">) {</span>
<a name="l_366"></a><span class="hl lin">  366 </span>				<span class="hl kwb">uint16_t</span> efh_id <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_367"></a><span class="hl lin">  367 </span>				<span class="hl kwb">uint16_t</span> efh_datasize <span class="hl opt">=</span> <span class="hl kwd">fget16LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_368"></a><span class="hl lin">  368 </span>				extra_len_used <span class="hl opt">+=</span> <span class="hl num">4</span> <span class="hl opt">+</span> efh_datasize<span class="hl opt">;</span>
<a name="l_369"></a><span class="hl lin">  369 </span>				<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> efh_datasize<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_370"></a><span class="hl lin">  370 </span>				<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;efh %04x  &quot;</span><span class="hl opt">,</span> efh_id<span class="hl opt">);</span>
<a name="l_371"></a><span class="hl lin">  371 </span>				<span class="hl slc">//http://svn.assembla.com/svn/os2utils/unzip60f/proginfo/extrafld.txt</span>
<a name="l_372"></a><span class="hl lin">  372 </span>				<span class="hl slc">//http://emerge.hg.sourceforge.net/hgweb/emerge/emerge/diff/c2f208617d32/Source/unzip/proginfo/extrafld.txt</span>
<a name="l_373"></a><span class="hl lin">  373 </span>				<span class="hl kwa">if</span> <span class="hl opt">(</span>efh_id <span class="hl opt">==</span> <span class="hl num">0x07c8</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP Macintosh (old, J. Lee)</span>
<a name="l_374"></a><span class="hl lin">  374 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x334d</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP Macintosh (new, D. Haase's 'Mac3' field)</span>
<a name="l_375"></a><span class="hl lin">  375 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x4d49</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP OpenVMS (obsolete)</span>
<a name="l_376"></a><span class="hl lin">  376 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x5855</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP UNIX (original; also OS/2, NT, etc.)</span>
<a name="l_377"></a><span class="hl lin">  377 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x6375</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP UTF-8 comment field</span>
<a name="l_378"></a><span class="hl lin">  378 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x7075</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP UTF-8 name field</span>
<a name="l_379"></a><span class="hl lin">  379 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x7855</span> <span class="hl opt">||</span>  <span class="hl slc">// Info-ZIP UNIX (16-bit UID/GID info)</span>
<a name="l_380"></a><span class="hl lin">  380 </span>					efh_id <span class="hl opt">==</span> <span class="hl num">0x7875</span><span class="hl opt">)</span>    <span class="hl slc">// Info-ZIP UNIX 3rd generation (generic UID/GID, ...)</span>
<a name="l_381"></a><span class="hl lin">  381 </span>
<a name="l_382"></a><span class="hl lin">  382 </span>					<span class="hl slc">// 7zip ALSO is 2 byte checksum, but I have no way to find them.  NOTE, it is 2 bytes of CRC, not timestamp like InfoZip.</span>
<a name="l_383"></a><span class="hl lin">  383 </span>					<span class="hl slc">// OLD winzip (I think 8.01 or before), is also supposed to be 2 byte.</span>
<a name="l_384"></a><span class="hl lin">  384 </span>					<span class="hl slc">// old v1 pkzip (the DOS builds) are 2 byte checksums.</span>
<a name="l_385"></a><span class="hl lin">  385 </span>				<span class="hl opt">{</span>
<a name="l_386"></a><span class="hl lin">  386 </span>					zfp<span class="hl opt">-&gt;</span>unix_made <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_387"></a><span class="hl lin">  387 </span>					zfp<span class="hl opt">-&gt;</span>check_bytes <span class="hl opt">=</span> <span class="hl num">2</span><span class="hl opt">;</span>
<a name="l_388"></a><span class="hl lin">  388 </span>					zfp<span class="hl opt">-&gt;</span>check_in_crc <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_389"></a><span class="hl lin">  389 </span>				<span class="hl opt">}</span>
<a name="l_390"></a><span class="hl lin">  390 </span>			<span class="hl opt">}</span>
<a name="l_391"></a><span class="hl lin">  391 </span>		<span class="hl opt">}</span>
<a name="l_392"></a><span class="hl lin">  392 </span>		<span class="hl kwa">else if</span> <span class="hl opt">(</span>extrafield_length<span class="hl opt">)</span>
<a name="l_393"></a><span class="hl lin">  393 </span>			<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> extrafield_length<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_394"></a><span class="hl lin">  394 </span>
<a name="l_395"></a><span class="hl lin">  395 </span>		<span class="hl kwa">if</span> <span class="hl opt">(</span>force_2_byte_checksum<span class="hl opt">)</span>
<a name="l_396"></a><span class="hl lin">  396 </span>			zfp<span class="hl opt">-&gt;</span>check_bytes <span class="hl opt">=</span> <span class="hl num">2</span><span class="hl opt">;</span>
<a name="l_397"></a><span class="hl lin">  397 </span>
<a name="l_398"></a><span class="hl lin">  398 </span>		<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span>
<a name="l_399"></a><span class="hl lin">  399 </span>			<span class="hl str">&quot;%s-&gt;%s PKZIP Encr:%s%s cmplen=%d, decmplen=%d, crc=%X</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span>
<a name="l_400"></a><span class="hl lin">  400 </span>			<span class="hl kwd">jtr_basename</span><span class="hl opt">(</span>zip_fname<span class="hl opt">),</span> filename<span class="hl opt">,</span> zfp<span class="hl opt">-&gt;</span>check_bytes<span class="hl opt">==</span><span class="hl num">2</span>?<span class="hl str">&quot; 2b chk,&quot;</span><span class="hl opt">:</span><span class="hl str">&quot;&quot;</span><span class="hl opt">,</span> zfp<span class="hl opt">-&gt;</span>check_in_crc?<span class="hl str">&quot;&quot;</span><span class="hl opt">:</span><span class="hl str">&quot; TS_chk,&quot;</span><span class="hl opt">,</span> p<span class="hl opt">-&gt;</span>cmp_len<span class="hl opt">,</span> p<span class="hl opt">-&gt;</span>decomp_len<span class="hl opt">,</span> p<span class="hl opt">-&gt;</span>crc<span class="hl opt">);</span>
<a name="l_401"></a><span class="hl lin">  401 </span>
<a name="l_402"></a><span class="hl lin">  402 </span>		p<span class="hl opt">-&gt;</span>hash_data <span class="hl opt">=</span> <span class="hl kwd">mem_alloc_tiny</span><span class="hl opt">(</span>p<span class="hl opt">-&gt;</span>cmp_len<span class="hl opt">+</span><span class="hl num">1</span><span class="hl opt">,</span> MEM_ALIGN_WORD<span class="hl opt">);</span>
<a name="l_403"></a><span class="hl lin">  403 </span>		<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">fread</span><span class="hl opt">(</span>p<span class="hl opt">-&gt;</span>hash_data<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">,</span> p<span class="hl opt">-&gt;</span>cmp_len<span class="hl opt">,</span> fp<span class="hl opt">) !=</span> p<span class="hl opt">-&gt;</span>cmp_len<span class="hl opt">) {</span>
<a name="l_404"></a><span class="hl lin">  404 </span>			<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Error, fread could not read the data from the file:  %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> zip_fname<span class="hl opt">);</span>
<a name="l_405"></a><span class="hl lin">  405 </span>			<span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_406"></a><span class="hl lin">  406 </span>		<span class="hl opt">}</span>
<a name="l_407"></a><span class="hl lin">  407 </span>
<a name="l_408"></a><span class="hl lin">  408 </span>		<span class="hl slc">// Ok, now set checksum bytes.  This will depend upon if from crc, or from timestamp</span>
<a name="l_409"></a><span class="hl lin">  409 </span>			<span class="hl kwd">sprintf</span> <span class="hl opt">(</span>p<span class="hl opt">-&gt;</span>chksum<span class="hl opt">,</span> <span class="hl str">&quot;%02x%02x&quot;</span><span class="hl opt">, (</span>p<span class="hl opt">-&gt;</span>crc<span class="hl opt">&gt;&gt;</span><span class="hl num">24</span><span class="hl opt">)&amp;</span><span class="hl num">0xFF</span><span class="hl opt">, (</span>p<span class="hl opt">-&gt;</span>crc<span class="hl opt">&gt;&gt;</span><span class="hl num">16</span><span class="hl opt">)&amp;</span><span class="hl num">0xFF</span><span class="hl opt">);</span>
<a name="l_410"></a><span class="hl lin">  410 </span>		<span class="hl kwd">sprintf</span> <span class="hl opt">(</span>p<span class="hl opt">-&gt;</span>chksum2<span class="hl opt">,</span> <span class="hl str">&quot;%02x%02x&quot;</span><span class="hl opt">,</span> lastmod_time<span class="hl opt">&gt;&gt;</span><span class="hl num">8</span><span class="hl opt">,</span> lastmod_time<span class="hl opt">&amp;</span><span class="hl num">0xFF</span><span class="hl opt">);</span>
<a name="l_411"></a><span class="hl lin">  411 </span>
<a name="l_412"></a><span class="hl lin">  412 </span>		<span class="hl kwa">return</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_413"></a><span class="hl lin">  413 </span>
<a name="l_414"></a><span class="hl lin">  414 </span>	<span class="hl opt">}</span>
<a name="l_415"></a><span class="hl lin">  415 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;%s-&gt;%s is not encrypted, or stored with non-handled compression type</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> zip_fname<span class="hl opt">,</span> filename<span class="hl opt">);</span>
<a name="l_416"></a><span class="hl lin">  416 </span>	<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> extrafield_length<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_417"></a><span class="hl lin">  417 </span>	<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> p<span class="hl opt">-&gt;</span>cmp_len<span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_418"></a><span class="hl lin">  418 </span>
<a name="l_419"></a><span class="hl lin">  419 </span>	<span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_420"></a><span class="hl lin">  420 </span><span class="hl opt">}</span>
<a name="l_421"></a><span class="hl lin">  421 </span>
<a name="l_422"></a><span class="hl lin">  422 </span><span class="hl kwb">static void</span> <span class="hl kwd">process_old_zip</span><span class="hl opt">(</span><span class="hl kwb">const char</span> <span class="hl opt">*</span>fname<span class="hl opt">)</span>
<a name="l_423"></a><span class="hl lin">  423 </span><span class="hl opt">{</span>
<a name="l_424"></a><span class="hl lin">  424 </span>	<span class="hl kwb">FILE</span> <span class="hl opt">*</span>fp<span class="hl opt">;</span>
<a name="l_425"></a><span class="hl lin">  425 </span>
<a name="l_426"></a><span class="hl lin">  426 </span>	<span class="hl kwb">int</span> count_of_hashes <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_427"></a><span class="hl lin">  427 </span>	zip_ptr hashes<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">],</span> curzip<span class="hl opt">;</span>
<a name="l_428"></a><span class="hl lin">  428 </span>	zip_file zfp<span class="hl opt">;</span>
<a name="l_429"></a><span class="hl lin">  429 </span>
<a name="l_430"></a><span class="hl lin">  430 </span>	<span class="hl kwb">char</span> path<span class="hl opt">[</span>LARGE_ENOUGH<span class="hl opt">];</span>
<a name="l_431"></a><span class="hl lin">  431 </span>
<a name="l_432"></a><span class="hl lin">  432 </span>	zfp<span class="hl opt">.</span>check_in_crc <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_433"></a><span class="hl lin">  433 </span>	zfp<span class="hl opt">.</span>check_bytes <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_434"></a><span class="hl lin">  434 </span>	zfp<span class="hl opt">.</span>unix_made <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_435"></a><span class="hl lin">  435 </span>
<a name="l_436"></a><span class="hl lin">  436 </span>	<span class="hl kwa">if</span> <span class="hl opt">(!(</span>fp <span class="hl opt">=</span> <span class="hl kwd">fopen</span><span class="hl opt">(</span>fname<span class="hl opt">,</span> <span class="hl str">&quot;rb&quot;</span><span class="hl opt">))) {</span>
<a name="l_437"></a><span class="hl lin">  437 </span>		<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;! %s : %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">,</span> <span class="hl kwd">strerror</span><span class="hl opt">(</span>errno<span class="hl opt">));</span>
<a name="l_438"></a><span class="hl lin">  438 </span>		<span class="hl kwa">return</span><span class="hl opt">;</span>
<a name="l_439"></a><span class="hl lin">  439 </span>	<span class="hl opt">}</span>
<a name="l_440"></a><span class="hl lin">  440 </span>
<a name="l_441"></a><span class="hl lin">  441 </span>	<span class="hl kwa">while</span> <span class="hl opt">(!</span><span class="hl kwd">feof</span><span class="hl opt">(</span>fp<span class="hl opt">)) {</span>
<a name="l_442"></a><span class="hl lin">  442 </span>		<span class="hl kwb">uint32_t</span> id <span class="hl opt">=</span> <span class="hl kwd">fget32LE</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_443"></a><span class="hl lin">  443 </span>
<a name="l_444"></a><span class="hl lin">  444 </span>		<span class="hl kwa">if</span> <span class="hl opt">(</span>id <span class="hl opt">==</span> <span class="hl num">0x04034b50</span>UL<span class="hl opt">) {</span>	<span class="hl com">/* local header */</span>
<a name="l_445"></a><span class="hl lin">  445 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">LoadZipBlob</span><span class="hl opt">(</span>fp<span class="hl opt">, &amp;</span>curzip<span class="hl opt">, &amp;</span>zfp<span class="hl opt">,</span> fname<span class="hl opt">) &amp;&amp;</span> curzip<span class="hl opt">.</span>decomp_len <span class="hl opt">&gt;</span> <span class="hl num">3</span><span class="hl opt">) {</span>
<a name="l_446"></a><span class="hl lin">  446 </span>				<span class="hl kwa">if</span> <span class="hl opt">(!</span>count_of_hashes<span class="hl opt">)</span>
<a name="l_447"></a><span class="hl lin">  447 </span>					<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span>count_of_hashes<span class="hl opt">++]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_448"></a><span class="hl lin">  448 </span>				<span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_449"></a><span class="hl lin">  449 </span>					<span class="hl kwa">if</span> <span class="hl opt">(</span>count_of_hashes <span class="hl opt">==</span> <span class="hl num">1</span><span class="hl opt">) {</span>
<a name="l_450"></a><span class="hl lin">  450 </span>						<span class="hl kwa">if</span> <span class="hl opt">(</span>curzip<span class="hl opt">.</span>cmp_len <span class="hl opt">&lt;</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">) {</span>
<a name="l_451"></a><span class="hl lin">  451 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span>count_of_hashes<span class="hl opt">++]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_452"></a><span class="hl lin">  452 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_453"></a><span class="hl lin">  453 </span>						<span class="hl opt">}</span> <span class="hl kwa">else</span>
<a name="l_454"></a><span class="hl lin">  454 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span>count_of_hashes<span class="hl opt">++]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_455"></a><span class="hl lin">  455 </span>					<span class="hl opt">}</span>
<a name="l_456"></a><span class="hl lin">  456 </span>					<span class="hl kwa">else if</span> <span class="hl opt">(</span>count_of_hashes <span class="hl opt">==</span> <span class="hl num">2</span><span class="hl opt">) {</span>
<a name="l_457"></a><span class="hl lin">  457 </span>						<span class="hl kwa">if</span> <span class="hl opt">(</span>curzip<span class="hl opt">.</span>cmp_len <span class="hl opt">&lt;</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">) {</span>
<a name="l_458"></a><span class="hl lin">  458 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span>count_of_hashes<span class="hl opt">++]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_459"></a><span class="hl lin">  459 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_460"></a><span class="hl lin">  460 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_461"></a><span class="hl lin">  461 </span>						<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>curzip<span class="hl opt">.</span>cmp_len <span class="hl opt">&lt;</span> hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">].</span>cmp_len<span class="hl opt">) {</span>
<a name="l_462"></a><span class="hl lin">  462 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span>count_of_hashes<span class="hl opt">++]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_463"></a><span class="hl lin">  463 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_464"></a><span class="hl lin">  464 </span>						<span class="hl opt">}</span> <span class="hl kwa">else</span>
<a name="l_465"></a><span class="hl lin">  465 </span>							<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span>count_of_hashes<span class="hl opt">++]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_466"></a><span class="hl lin">  466 </span>					<span class="hl opt">}</span>
<a name="l_467"></a><span class="hl lin">  467 </span>					<span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_468"></a><span class="hl lin">  468 </span>						<span class="hl kwb">int</span> done<span class="hl opt">=</span><span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_469"></a><span class="hl lin">  469 </span>						<span class="hl kwa">if</span> <span class="hl opt">(</span>curzip<span class="hl opt">.</span>magic_type <span class="hl opt">&amp;&amp;</span> curzip<span class="hl opt">.</span>cmp_len <span class="hl opt">&gt;</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">) {</span>
<a name="l_470"></a><span class="hl lin">  470 </span>							<span class="hl slc">// if we have a magic type, we will replace any NON magic type, for the 2nd and 3rd largest, without caring about</span>
<a name="l_471"></a><span class="hl lin">  471 </span>							<span class="hl slc">// the size.</span>
<a name="l_472"></a><span class="hl lin">  472 </span>							<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">].</span>magic_type <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
<a name="l_473"></a><span class="hl lin">  473 </span>								<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">].</span>cmp_len <span class="hl opt">&lt;</span> curzip<span class="hl opt">.</span>cmp_len<span class="hl opt">) {</span>
<a name="l_474"></a><span class="hl lin">  474 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_475"></a><span class="hl lin">  475 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_476"></a><span class="hl lin">  476 </span>									done<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_477"></a><span class="hl lin">  477 </span>								<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_478"></a><span class="hl lin">  478 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_479"></a><span class="hl lin">  479 </span>									done<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_480"></a><span class="hl lin">  480 </span>								<span class="hl opt">}</span>
<a name="l_481"></a><span class="hl lin">  481 </span>							<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">].</span>magic_type <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">) {</span>
<a name="l_482"></a><span class="hl lin">  482 </span>								<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">].</span>cmp_len <span class="hl opt">&lt;</span> curzip<span class="hl opt">.</span>cmp_len<span class="hl opt">) {</span>
<a name="l_483"></a><span class="hl lin">  483 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_484"></a><span class="hl lin">  484 </span>									done<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_485"></a><span class="hl lin">  485 </span>								<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_486"></a><span class="hl lin">  486 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_487"></a><span class="hl lin">  487 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_488"></a><span class="hl lin">  488 </span>									done<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_489"></a><span class="hl lin">  489 </span>								<span class="hl opt">}</span>
<a name="l_490"></a><span class="hl lin">  490 </span>							<span class="hl opt">}</span>
<a name="l_491"></a><span class="hl lin">  491 </span>						<span class="hl opt">}</span>
<a name="l_492"></a><span class="hl lin">  492 </span>						<span class="hl kwa">if</span> <span class="hl opt">(!</span>done <span class="hl opt">&amp;&amp;</span> curzip<span class="hl opt">.</span>cmp_len <span class="hl opt">&lt;</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">) {</span>
<a name="l_493"></a><span class="hl lin">  493 </span>							<span class="hl slc">// we 'only' replace the smallest zip, and always keep as many any other magic as possible.</span>
<a name="l_494"></a><span class="hl lin">  494 </span>							<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>magic_type <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
<a name="l_495"></a><span class="hl lin">  495 </span>								<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_496"></a><span class="hl lin">  496 </span>							<span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_497"></a><span class="hl lin">  497 </span>								<span class="hl slc">// Ok, the 1st is a magic, we WILL keep it.</span>
<a name="l_498"></a><span class="hl lin">  498 </span>								<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">].</span>magic_type<span class="hl opt">) {</span>  <span class="hl slc">// Ok, we found our 2</span>
<a name="l_499"></a><span class="hl lin">  499 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_500"></a><span class="hl lin">  500 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_501"></a><span class="hl lin">  501 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_502"></a><span class="hl lin">  502 </span>								<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">].</span>magic_type<span class="hl opt">) {</span>  <span class="hl slc">// Ok, we found our 2</span>
<a name="l_503"></a><span class="hl lin">  503 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_504"></a><span class="hl lin">  504 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_505"></a><span class="hl lin">  505 </span>								<span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
<a name="l_506"></a><span class="hl lin">  506 </span>									<span class="hl slc">// found none.  So we will simply roll them down (like when #1 was a magic also).</span>
<a name="l_507"></a><span class="hl lin">  507 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_508"></a><span class="hl lin">  508 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]), &amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]),</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_509"></a><span class="hl lin">  509 </span>									<span class="hl kwd">memcpy</span><span class="hl opt">(&amp;(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]), &amp;</span>curzip<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>curzip<span class="hl opt">));</span>
<a name="l_510"></a><span class="hl lin">  510 </span>								<span class="hl opt">}</span>
<a name="l_511"></a><span class="hl lin">  511 </span>							<span class="hl opt">}</span>
<a name="l_512"></a><span class="hl lin">  512 </span>						<span class="hl opt">}</span>
<a name="l_513"></a><span class="hl lin">  513 </span>					<span class="hl opt">}</span>
<a name="l_514"></a><span class="hl lin">  514 </span>				<span class="hl opt">}</span>
<a name="l_515"></a><span class="hl lin">  515 </span>			<span class="hl opt">}</span>
<a name="l_516"></a><span class="hl lin">  516 </span>		<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>id <span class="hl opt">==</span> <span class="hl num">0x08074b50</span>UL<span class="hl opt">) {</span>	<span class="hl com">/* data descriptor */</span>
<a name="l_517"></a><span class="hl lin">  517 </span>			<span class="hl kwd">fseek</span><span class="hl opt">(</span>fp<span class="hl opt">,</span> <span class="hl num">12</span><span class="hl opt">,</span> SEEK_CUR<span class="hl opt">);</span>
<a name="l_518"></a><span class="hl lin">  518 </span>		<span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>id <span class="hl opt">==</span> <span class="hl num">0x02014b50</span>UL <span class="hl opt">||</span> id <span class="hl opt">==</span> <span class="hl num">0x06054b50</span>UL<span class="hl opt">) {</span>	<span class="hl com">/* central directory structures */</span>
<a name="l_519"></a><span class="hl lin">  519 </span>			<span class="hl kwa">goto</span> print_and_cleanup<span class="hl opt">;</span>
<a name="l_520"></a><span class="hl lin">  520 </span>		<span class="hl opt">}</span>
<a name="l_521"></a><span class="hl lin">  521 </span>	<span class="hl opt">}</span>
<a name="l_522"></a><span class="hl lin">  522 </span>
<a name="l_523"></a><span class="hl lin">  523 </span>print_and_cleanup<span class="hl opt">:;</span>
<a name="l_524"></a><span class="hl lin">  524 </span>	<span class="hl kwa">if</span> <span class="hl opt">(</span>count_of_hashes<span class="hl opt">) {</span>
<a name="l_525"></a><span class="hl lin">  525 </span>		<span class="hl kwb">int</span> i<span class="hl opt">=</span><span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_526"></a><span class="hl lin">  526 </span>		<span class="hl kwb">char</span> <span class="hl opt">*</span>bname<span class="hl opt">;</span>
<a name="l_527"></a><span class="hl lin">  527 </span>		<span class="hl kwd">strnzcpy</span><span class="hl opt">(</span>path<span class="hl opt">,</span> fname<span class="hl opt">,</span> <span class="hl kwa">sizeof</span><span class="hl opt">(</span>path<span class="hl opt">));</span>
<a name="l_528"></a><span class="hl lin">  528 </span>		bname <span class="hl opt">=</span> <span class="hl kwd">basename</span><span class="hl opt">(</span>path<span class="hl opt">);</span>
<a name="l_529"></a><span class="hl lin">  529 </span>
<a name="l_530"></a><span class="hl lin">  530 </span>		<span class="hl kwd">printf</span> <span class="hl opt">(</span><span class="hl str">&quot;%s:$pkzip2$%x*%x*&quot;</span><span class="hl opt">,</span> bname<span class="hl opt">,</span> count_of_hashes<span class="hl opt">,</span> zfp<span class="hl opt">.</span>check_bytes<span class="hl opt">);</span>
<a name="l_531"></a><span class="hl lin">  531 </span>		<span class="hl kwa">if</span> <span class="hl opt">(</span>checksum_only<span class="hl opt">)</span>
<a name="l_532"></a><span class="hl lin">  532 </span>			i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_533"></a><span class="hl lin">  533 </span>		<span class="hl kwa">for</span> <span class="hl opt">(;</span> i <span class="hl opt">&lt;</span> count_of_hashes<span class="hl opt">; ++</span>i<span class="hl opt">) {</span>
<a name="l_534"></a><span class="hl lin">  534 </span>			<span class="hl kwb">int</span> len <span class="hl opt">=</span> <span class="hl num">12</span><span class="hl opt">+</span><span class="hl num">24</span><span class="hl opt">;</span>
<a name="l_535"></a><span class="hl lin">  535 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>magic_type<span class="hl opt">)</span>
<a name="l_536"></a><span class="hl lin">  536 </span>				len <span class="hl opt">=</span> <span class="hl num">12</span><span class="hl opt">+</span><span class="hl num">180</span><span class="hl opt">;</span>
<a name="l_537"></a><span class="hl lin">  537 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span>len <span class="hl opt">&gt;</span> hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>cmp_len<span class="hl opt">)</span>
<a name="l_538"></a><span class="hl lin">  538 </span>				len <span class="hl opt">=</span> hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>cmp_len<span class="hl opt">;</span> <span class="hl slc">// even though we 'could' output a '2', we do not.  We only need one full inflate CRC check file.</span>
<a name="l_539"></a><span class="hl lin">  539 </span>			<span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;1*%x*%x*%x*%s*%s*%s*&quot;</span><span class="hl opt">,</span> hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>magic_type<span class="hl opt">,</span> hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>cmptype<span class="hl opt">,</span> len<span class="hl opt">,</span> hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>chksum<span class="hl opt">,</span> hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>chksum2<span class="hl opt">,</span> <span class="hl kwd">toHex</span><span class="hl opt">((</span><span class="hl kwb">unsigned char</span><span class="hl opt">*)</span>hashes<span class="hl opt">[</span>i<span class="hl opt">].</span>hash_data<span class="hl opt">,</span> len<span class="hl opt">));</span>
<a name="l_540"></a><span class="hl lin">  540 </span>		<span class="hl opt">}</span>
<a name="l_541"></a><span class="hl lin">  541 </span>		<span class="hl slc">// Ok, now output the 'little' one (the first).</span>
<a name="l_542"></a><span class="hl lin">  542 </span>		<span class="hl kwa">if</span> <span class="hl opt">(!</span>checksum_only<span class="hl opt">) {</span>
<a name="l_543"></a><span class="hl lin">  543 </span>			<span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%x*%x*%x*%x*%x*%x*%x*%x*&quot;</span><span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len <span class="hl opt">&lt;</span> inline_thr ? <span class="hl num">2</span> <span class="hl opt">:</span> <span class="hl num">3</span><span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>magic_type<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>decomp_len<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>crc<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>offset<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>offex<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmptype<span class="hl opt">);</span>
<a name="l_544"></a><span class="hl lin">  544 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len <span class="hl opt">&lt;</span> inline_thr<span class="hl opt">)</span>
<a name="l_545"></a><span class="hl lin">  545 </span>				<span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%x*%s*%s*%s*&quot;</span><span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>chksum<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>chksum2<span class="hl opt">,</span> <span class="hl kwd">toHex</span><span class="hl opt">((</span><span class="hl kwb">unsigned char</span><span class="hl opt">*)</span>hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>hash_data<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>cmp_len<span class="hl opt">));</span>
<a name="l_546"></a><span class="hl lin">  546 </span>			<span class="hl kwa">else</span>
<a name="l_547"></a><span class="hl lin">  547 </span>				<span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%x*%s*%s*%s*&quot;</span><span class="hl opt">, (</span><span class="hl kwb">unsigned int</span><span class="hl opt">)</span><span class="hl kwd">strlen</span><span class="hl opt">(</span>fname<span class="hl opt">),</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>chksum<span class="hl opt">,</span> hashes<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">].</span>chksum2<span class="hl opt">,</span> fname<span class="hl opt">);</span>
<a name="l_548"></a><span class="hl lin">  548 </span>		<span class="hl opt">}</span>
<a name="l_549"></a><span class="hl lin">  549 </span>		<span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;$/pkzip2$:::::%s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> fname<span class="hl opt">);</span>
<a name="l_550"></a><span class="hl lin">  550 </span>	<span class="hl opt">}</span>
<a name="l_551"></a><span class="hl lin">  551 </span>	<span class="hl kwd">fclose</span><span class="hl opt">(</span>fp<span class="hl opt">);</span>
<a name="l_552"></a><span class="hl lin">  552 </span><span class="hl opt">}</span>
<a name="l_553"></a><span class="hl lin">  553 </span>
<a name="l_554"></a><span class="hl lin">  554 </span><span class="hl kwb">static int</span> <span class="hl kwd">usage</span><span class="hl opt">(</span><span class="hl kwb">char</span> <span class="hl opt">*</span>name<span class="hl opt">) {</span>
<a name="l_555"></a><span class="hl lin">  555 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Usage: %s [options] [zip files]</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> name<span class="hl opt">);</span>
<a name="l_556"></a><span class="hl lin">  556 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot; -i &lt;inline threshold&gt; Set threshold for inlining data. Default is %d bytes</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> MAX_INLINE_SIZE<span class="hl opt">);</span>
<a name="l_557"></a><span class="hl lin">  557 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Options for 'old' PKZIP encrypted files only:</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_558"></a><span class="hl lin">  558 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot; -a &lt;filename&gt;   This is a 'known' ASCII file</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_559"></a><span class="hl lin">  559 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    Using 'ascii' mode is a serious speedup, IF all files are larger, and</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_560"></a><span class="hl lin">  560 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    you KNOW that at least one of them starts out as 'pure' ASCII data</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_561"></a><span class="hl lin">  561 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot; -o &lt;filename&gt;   Only use this file from the .zip file</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_562"></a><span class="hl lin">  562 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot; -c This will create a 'checksum only' hash.  If there are many encrypted</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_563"></a><span class="hl lin">  563 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    files in the .zip file, then this may be an option, and there will be</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_564"></a><span class="hl lin">  564 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    enough data that false possitives will not be seen.  If the .zip is 2</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_565"></a><span class="hl lin">  565 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    byte checksums, and there are 3 or more of them, then we have 48 bits</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_566"></a><span class="hl lin">  566 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    knowledge, which 'may' be enough to crack the password, without having</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_567"></a><span class="hl lin">  567 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    to force the user to have the .zip file present</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_568"></a><span class="hl lin">  568 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot; -n Do not look for any magic file types in this zip.  If you know that</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_569"></a><span class="hl lin">  569 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    are files with one of the 'magic' extensions, but they are not the right</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_570"></a><span class="hl lin">  570 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    type files (some *.doc files that ARE NOT MS Office Word documents), then</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_571"></a><span class="hl lin">  571 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    this switch will keep them from being detected this way.  NOTE, that</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_572"></a><span class="hl lin">  572 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    the 'magic' logic will only be used in john, under certain situations.</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_573"></a><span class="hl lin">  573 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;    Most of these situations are when there are only 'stored' files in the zip</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_574"></a><span class="hl lin">  574 </span>	<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot; -2 Force 2 byte checksum computation</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_575"></a><span class="hl lin">  575 </span>
<a name="l_576"></a><span class="hl lin">  576 </span>	<span class="hl kwa">return</span> EXIT_FAILURE<span class="hl opt">;</span>
<a name="l_577"></a><span class="hl lin">  577 </span><span class="hl opt">}</span>
<a name="l_578"></a><span class="hl lin">  578 </span>
<a name="l_579"></a><span class="hl lin">  579 </span><span class="hl kwb">int</span> <span class="hl kwd">zip2john</span><span class="hl opt">(</span><span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span> <span class="hl opt">**</span>argv<span class="hl opt">)</span>
<a name="l_580"></a><span class="hl lin">  580 </span><span class="hl opt">{</span>
<a name="l_581"></a><span class="hl lin">  581 </span>	<span class="hl kwb">int</span> c<span class="hl opt">;</span>
<a name="l_582"></a><span class="hl lin">  582 </span>
<a name="l_583"></a><span class="hl lin">  583 </span>	<span class="hl com">/* Parse command line */</span>
<a name="l_584"></a><span class="hl lin">  584 </span>	<span class="hl kwa">while</span> <span class="hl opt">((</span>c <span class="hl opt">=</span> <span class="hl kwd">getopt</span><span class="hl opt">(</span>argc<span class="hl opt">,</span> argv<span class="hl opt">,</span> <span class="hl str">&quot;a:o:i:cn2&quot;</span><span class="hl opt">)) != -</span><span class="hl num">1</span><span class="hl opt">) {</span>
<a name="l_585"></a><span class="hl lin">  585 </span>		<span class="hl kwa">switch</span> <span class="hl opt">(</span>c<span class="hl opt">) {</span>
<a name="l_586"></a><span class="hl lin">  586 </span>		<span class="hl kwa">case</span> <span class="hl str">'i'</span><span class="hl opt">:</span>
<a name="l_587"></a><span class="hl lin">  587 </span>			inline_thr <span class="hl opt">= (</span><span class="hl kwb">int</span><span class="hl opt">)</span><span class="hl kwd">strtol</span><span class="hl opt">(</span>optarg<span class="hl opt">,</span> NULL<span class="hl opt">,</span> <span class="hl num">0</span><span class="hl opt">);</span>
<a name="l_588"></a><span class="hl lin">  588 </span>			<span class="hl kwa">if</span> <span class="hl opt">(</span>inline_thr <span class="hl opt">&gt;</span> MAX_THR<span class="hl opt">) {</span>
<a name="l_589"></a><span class="hl lin">  589 </span>				<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;%s error: threshold %d, can't&quot;</span>
<a name="l_590"></a><span class="hl lin">  590 </span>				        <span class="hl str">&quot; be larger than %d</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> argv<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">],</span>
<a name="l_591"></a><span class="hl lin">  591 </span>				        inline_thr<span class="hl opt">,</span> MAX_THR<span class="hl opt">);</span>
<a name="l_592"></a><span class="hl lin">  592 </span>				<span class="hl kwa">return</span> EXIT_FAILURE<span class="hl opt">;</span>
<a name="l_593"></a><span class="hl lin">  593 </span>			<span class="hl opt">}</span>
<a name="l_594"></a><span class="hl lin">  594 </span>			<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_595"></a><span class="hl lin">  595 </span>		<span class="hl kwa">case</span> <span class="hl str">'a'</span><span class="hl opt">:</span>
<a name="l_596"></a><span class="hl lin">  596 </span>			ascii_fname <span class="hl opt">=</span> optarg<span class="hl opt">;</span>
<a name="l_597"></a><span class="hl lin">  597 </span>			<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Using file %s as an 'ASCII' quick check file</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> ascii_fname<span class="hl opt">);</span>
<a name="l_598"></a><span class="hl lin">  598 </span>			<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_599"></a><span class="hl lin">  599 </span>		<span class="hl kwa">case</span> <span class="hl str">'o'</span><span class="hl opt">:</span>
<a name="l_600"></a><span class="hl lin">  600 </span>			only_fname <span class="hl opt">=</span> optarg<span class="hl opt">;</span>
<a name="l_601"></a><span class="hl lin">  601 </span>			<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Using file %s as only file to check</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">,</span> only_fname<span class="hl opt">);</span>
<a name="l_602"></a><span class="hl lin">  602 </span>			<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_603"></a><span class="hl lin">  603 </span>		<span class="hl kwa">case</span> <span class="hl str">'c'</span><span class="hl opt">:</span>
<a name="l_604"></a><span class="hl lin">  604 </span>			checksum_only <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_605"></a><span class="hl lin">  605 </span>			<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Outputing hashes that are 'checksum ONLY' hashes</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_606"></a><span class="hl lin">  606 </span>			<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_607"></a><span class="hl lin">  607 </span>		<span class="hl kwa">case</span> <span class="hl str">'n'</span><span class="hl opt">:</span>
<a name="l_608"></a><span class="hl lin">  608 </span>			use_magic <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<a name="l_609"></a><span class="hl lin">  609 </span>			<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Ignoring any checking of file 'magic' signatures</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_610"></a><span class="hl lin">  610 </span>			<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_611"></a><span class="hl lin">  611 </span>		<span class="hl kwa">case</span> <span class="hl str">'2'</span><span class="hl opt">:</span>
<a name="l_612"></a><span class="hl lin">  612 </span>			force_2_byte_checksum <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
<a name="l_613"></a><span class="hl lin">  613 </span>			<span class="hl kwd">fprintf</span><span class="hl opt">(</span>stderr<span class="hl opt">,</span> <span class="hl str">&quot;Forcing a 2 byte checksum detection</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl opt">);</span>
<a name="l_614"></a><span class="hl lin">  614 </span>			<span class="hl kwa">break</span><span class="hl opt">;</span>
<a name="l_615"></a><span class="hl lin">  615 </span>		<span class="hl kwa">case</span> <span class="hl str">'?'</span><span class="hl opt">:</span>
<a name="l_616"></a><span class="hl lin">  616 </span>		<span class="hl kwa">default</span><span class="hl opt">:</span>
<a name="l_617"></a><span class="hl lin">  617 </span>			<span class="hl kwa">return</span> <span class="hl kwd">usage</span><span class="hl opt">(</span>argv<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
<a name="l_618"></a><span class="hl lin">  618 </span>		<span class="hl opt">}</span>
<a name="l_619"></a><span class="hl lin">  619 </span>	<span class="hl opt">}</span>
<a name="l_620"></a><span class="hl lin">  620 </span>	argc <span class="hl opt">-=</span> optind<span class="hl opt">;</span>
<a name="l_621"></a><span class="hl lin">  621 </span>	<span class="hl kwa">if</span><span class="hl opt">(</span>argc <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl opt">)</span>
<a name="l_622"></a><span class="hl lin">  622 </span>		<span class="hl kwa">return</span> <span class="hl kwd">usage</span><span class="hl opt">(</span>argv<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
<a name="l_623"></a><span class="hl lin">  623 </span>	argv <span class="hl opt">+=</span> optind<span class="hl opt">;</span>
<a name="l_624"></a><span class="hl lin">  624 </span>
<a name="l_625"></a><span class="hl lin">  625 </span>	<span class="hl kwa">while</span><span class="hl opt">(</span>argc<span class="hl opt">--)</span>
<a name="l_626"></a><span class="hl lin">  626 </span>		<span class="hl kwd">process_file</span><span class="hl opt">(*</span>argv<span class="hl opt">++);</span>
<a name="l_627"></a><span class="hl lin">  627 </span>
<a name="l_628"></a><span class="hl lin">  628 </span>	<span class="hl kwd">cleanup_tiny_memory</span><span class="hl opt">();</span>
<a name="l_629"></a><span class="hl lin">  629 </span>	<span class="hl kwd">MEMDBG_PROGRAM_EXIT_CHECKS</span><span class="hl opt">(</span>stderr<span class="hl opt">);</span>
<a name="l_630"></a><span class="hl lin">  630 </span>
<a name="l_631"></a><span class="hl lin">  631 </span>	<span class="hl kwa">return</span> EXIT_SUCCESS<span class="hl opt">;</span>
<a name="l_632"></a><span class="hl lin">  632 </span><span class="hl opt">}</span>
</PRE></BODY></HTML><!--HTML generated by highlight, http://www.andre-simon.de/-->
